<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KMIT Marks Portal – Admin Dashboard v2 (Upgraded)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    section {
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body class="min-h-screen flex bg-gray-100">

<!-- OVERLAY FOR MOBILE SIDEBAR -->
<div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/40 z-20"></div>

<!-- FLOATING SIDEBAR TOGGLE -->
<button
  id="sidebar-toggle"
  class="fixed top-3 left-3 z-30 inline-flex items-center justify-center rounded-full bg-slate-900 text-white w-10 h-10 shadow-lg md:hidden"
  aria-label="Toggle navigation"
>
  ☰
</button>

<!-- ERROR BOX -->
<div id="errorBox" class="hidden m-4 p-3 bg-red-100 text-red-700 text-sm rounded fixed top-16 right-4 z-30 max-w-md shadow"></div>

<!-- SIDEBAR -->
<aside
  id="sidebar"
  class="hidden md:flex w-64 bg-slate-900 text-white flex-col fixed md:static inset-y-0 left-0 z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-200"
>
  <div class="p-4 border-b border-slate-700 text-lg font-bold flex items-center justify-between">
    <span>KMIT Admin Panel</span>
  </div>
  <nav class="flex-1 p-3 space-y-2 text-sm" id="nav-links">
    <button data-target="overview" class="w-full text-left px-3 py-2 rounded bg-slate-800">Overview</button>
    <button data-target="marks" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">Marks Management</button>
    <button data-target="roles" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">User & Role Management</button>
    <button data-target="rolemanager" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">Role Manager</button>
    <button data-target="users" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">Users Directory</button>
    <button data-target="bulkroles" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">Bulk Role Upload</button>
    <button data-target="reports" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">Reports</button>
    <button data-target="logs" class="w-full text-left px-3 py-2 rounded hover:bg-slate-800">System Logs</button>
  </nav>
  <div class="p-3 border-t border-slate-700 text-xs">
    <div id="admin-email" class="truncate mb-2">Loading...</div>
    <button id="sign-out-btn" class="w-full bg-red-500 py-2 rounded text-xs">Sign Out</button>
  </div>
</aside>

<!-- MAIN APP -->
<main id="mainApp" class="hidden flex-1 md:ml-64 p-6 overflow-y-auto">
  <!-- OVERVIEW -->
  <section id="panel-overview">
    <h2 class="text-2xl font-semibold mb-4">Overview</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white shadow p-4 rounded">Total Students: —</div>
      <div class="bg-white shadow p-4 rounded">Active Faculty: —</div>
      <div class="bg-white shadow p-4 rounded">Pending Approvals: —</div>
    </div>
  </section>

  <!-- MARKS MANAGEMENT -->
  <section id="panel-marks" class="hidden">
    <h2 class="text-2xl font-semibold mb-4">Marks Management</h2>

    <!-- FILTERS -->
    <div class="bg-white p-4 shadow rounded mb-4 grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
      <div>
        <label class="block mb-1 font-semibold">Batch</label>
        <select id="marks-batch" class="border p-2 w-full rounded">
          <option value="">Select Batch</option>
          <option>2021-2022</option>
          <option>2022-2023</option>
          <option>2023-2024</option>
          <option>2024-2025</option>
          <option>2025-2026</option>
        </select>
      </div>

      <div>
        <label class="block mb-1 font-semibold">Regulation</label>
        <select id="marks-reg" class="border p-2 w-full rounded">
          <option>KR24</option>
          <option>R23</option>
          <option>R22</option>
        </select>
      </div>

      <div>
        <label class="block mb-1 font-semibold">Branch</label>
        <select id="marks-branch" class="border p-2 w-full rounded">
          <option>CSE</option>
          <option>CSD</option>
          <option>CSM</option>
          <option>IT</</option>
          <option>ECE</option>
        </select>
      </div>

      <div>
        <label class="block mb-1 font-semibold">Year</label>
        <select id="marks-year" class="border p-2 w-full rounded">
          <option>I</option>
          <option>II</option>
          <option>III</option>
          <option>IV</option>
        </select>
      </div>

      <div>
        <label class="block mb-1 font-semibold">Semester</label>
        <select id="marks-sem" class="border p-2 w-full rounded">
          <option>I</option>
          <option>II</option>
        </select>
      </div>

      <div>
        <label class="block mb-1 font-semibold">Exam Type</label>
        <select id="marks-exam" class="border p-2 w-full rounded">
          <option value="MID1">I MID</option>
          <option value="MID2">II MID</option>
          <option value="SEM">SEMESTER</option>
        </select>
      </div>

      <div>
        <label class="block mb-1 font-semibold">Paper Type</label>
        <select id="marks-paper-type" class="border p-2 w-full rounded">
          <option value="THEORY">THEORY</option>
          <option value="LAB">LAB</option>
        </select>
      </div>

      <div>
        <label class="block mb-1 font-semibold">Subject</label>
        <select id="marks-subject" class="border p-2 w-full rounded">
          <option value="">Select subject (fill filters)</option>
        </select>
      </div>
    </div>

    <!-- SUBJECT MASTER CSV -->
    <div class="bg-white p-4 rounded shadow mb-4 text-xs">
      <h3 class="font-semibold mb-2 text-sm">Subject Master (Optional – CSV Upload)</h3>
      <p class="mb-2 text-slate-600">
        CSV columns: <span class="font-mono">regulation, branch, year, sem, subjectName, subjectCode, type</span>
        &nbsp;| type = THEORY / LAB
      </p>
      <div class="flex flex-wrap gap-3 items-center">
        <input type="file" id="subject-csv" accept=".csv" class="text-xs" />
        <button id="subject-upload-btn" class="bg-emerald-700 text-white px-3 py-1 rounded text-xs">
          Upload Subject CSV
        </button>
        <button id="subject-sample-btn" class="bg-slate-700 text-white px-3 py-1 rounded text-xs">
          Download Sample CSV
        </button>
      </div>
      <p id="subject-upload-status" class="mt-2 text-xs text-slate-600"></p>
    </div>

    <!-- COLUMN EDITOR -->
    <div id="column-editor" class="bg-white p-4 shadow rounded mb-4 text-sm">
      <h3 class="font-semibold mb-2 text-sm">Template Columns (Click to Remove)</h3>

      <div class="mb-2 text-[11px] text-slate-600">Fixed Columns</div>
      <div class="flex flex-wrap gap-2 mb-3" id="fixed-columns">
        <span class="px-2 py-1 bg-slate-200 rounded-full text-[11px]">S.No</span>
        <span class="px-2 py-1 bg-slate-200 rounded-full text-[11px]">Hall Ticket No</span>
        <span class="px-2 py-1 bg-slate-200 rounded-full text-[11px]">Name of the Student</span>
      </div>

      <div class="flex items-center justify-between mb-1">
        <div class="text-[11px] text-slate-600">Dynamic Columns</div>
        <div class="text-[10px] text-slate-500">(Defaults depend on THEORY / LAB)</div>
      </div>

      <div id="dynamic-columns" class="flex flex-wrap gap-2 mb-3"></div>

      <div class="flex gap-2 mb-2">
        <input
          id="new-column-name"
          class="border p-2 text-xs rounded flex-1"
          placeholder="e.g. 1a, 2b, Assignment, Objective, Total, Remarks"
        />
        <button id="add-column-btn" class="bg-emerald-600 text-white px-3 py-2 rounded text-xs">
          Add Column
        </button>
      </div>
      <p class="text-[11px] text-slate-500">Tip: Click any chip above to delete that column.</p>
    </div>

    <!-- GENERATE TEMPLATE -->
    <button
      id="generate-template"
      class="bg-indigo-600 text-white px-4 py-2 rounded text-sm mb-4"
    >
      Generate Template (Option A)
    </button>

    <!-- TEMPLATE PREVIEW -->
    <div id="template-preview" class="hidden bg-white p-4 shadow rounded overflow-x-auto text-xs"></div>
  </section>

  <!-- ROLES (basic form) -->
  <section id="panel-roles" class="hidden">
    <h2 class="text-2xl font-semibold mb-4">User & Role Management</h2>
    <form id="role-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-white p-4 shadow rounded">
      <input name="uid" placeholder="User UID" class="border p-2 rounded text-sm" required />
      <select name="role" class="border p-2 rounded text-sm">
        <option value="ADMIN">ADMIN</option>
        <option value="FACULTY">FACULTY</option>
        <option value="HOD">HOD</option>
        <option value="EXAMCELL">EXAMCELL</option>
      </select>
      <button class="bg-indigo-600 text-white p-2 rounded text-sm">Save Role</button>
    </form>
    <div id="role-status" class="text-xs mt-2 text-slate-600"></div>
  </section>

  <!-- ROLE MANAGER (enhanced) -->
  <section id="panel-rolemanager" class="hidden">
    <h2 class="text-2xl font-semibold mb-2">Role Manager (Admin Only)</h2>
    <p class="text-xs text-slate-500 mb-4">
      Roles are stored in
      <code class="bg-slate-100 px-1 rounded">artifacts/kmit-marks-portal/users/{uid}/user_config/role</code>.
      Use this panel to <span class="font-semibold">view</span> and <span class="font-semibold">update</span> roles.
    </p>

    <div class="bg-white rounded shadow p-4 text-xs space-y-3 max-w-xl">
      <div>
        <label class="block font-semibold mb-1">Target User UID</label>
        <input
          id="rm-uid"
          class="w-full border border-slate-300 rounded px-2 py-1 text-xs"
          placeholder="Paste Firebase Auth UID (copy from Authentication → Users)"
        />
      </div>

      <div>
        <label class="block font-semibold mb-1">Target User Email (optional)</label>
        <div class="flex flex-col gap-2">
          <div class="flex gap-2">
            <input
              id="rm-email"
              class="flex-1 border border-slate-300 rounded px-2 py-1 text-xs"
              placeholder="user@example.com"
            />
            <button
              id="rm-email-search"
              class="px-3 py-1.5 rounded bg-slate-800 text-white text-[11px] hover:bg-slate-900"
              type="button"
            >
              Search by Email
            </button>
          </div>
          <p class="text-[11px] text-slate-500">
            If email is stored in Firestore, search will auto-fill UID & current role.
          </p>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <button
          id="rm-load"
          class="px-3 py-1.5 rounded bg-slate-800 text-white text-xs hover:bg-slate-900"
        >
          Load Current Role
        </button>
        <span id="rm-current-role" class="text-[11px] text-slate-600"></span>
      </div>

      <div>
        <label class="block font-semibold mb-1">Set New Role</label>
        <select
          id="rm-role"
          class="w-full border border-slate-300 rounded px-2 py-1 text-xs"
        >
          <option value="FACULTY">FACULTY</option>
          <option value="HOD">HOD</option>
          <option value="EXAMCELL">EXAMCELL</option>
          <option value="ADMIN">ADMIN</option>
          <option value="NONE">NONE (clear role)</option>
        </select>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <button
          id="rm-save"
          class="px-4 py-1.5 rounded bg-emerald-600 text-white text-xs hover:bg-emerald-700"
        >
          Save Role
        </button>
        <span id="rm-status" class="text-[11px] text-slate-600"></span>
      </div>
    </div>
  </section>

  <!-- USERS DIRECTORY -->
  <section id="panel-users" class="hidden">
    <h2 class="text-2xl font-semibold mb-2">Users Directory</h2>
    <p class="text-xs text-slate-500 mb-4">
      Listing users from Firestore role documents:
      <code class="bg-slate-100 px-1 rounded">artifacts/kmit-marks-portal/users/{uid}/user_config/role</code>.
      Only <span class="font-semibold">ADMIN</span> can view this.
    </p>

    <div class="bg-white rounded shadow p-4 text-xs">
      <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
        <button
          id="users-reload"
          class="px-3 py-1.5 rounded bg-slate-800 text-white text-[11px] hover:bg-slate-900"
          type="button"
        >
          Reload Users
        </button>
        <span id="users-status" class="text-[11px] text-slate-600"></span>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full border border-slate-200 text-[11px]">
          <thead class="bg-slate-100">
            <tr>
              <th class="border border-slate-200 px-2 py-1 text-left">Email</th>
              <th class="border border-slate-200 px-2 py-1 text-left">UID</th>
              <th class="border border-slate-200 px-2 py-1 text-left">Role</th>
              <th class="border border-slate-200 px-2 py-1 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="users-table-body"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- BULK ROLES -->
  <section id="panel-bulkroles" class="hidden">
    <h2 class="text-2xl font-semibold mb-4">Bulk Role Upload</h2>
    <div class="bg-white p-4 rounded shadow mb-4">
      <h3 class="font-semibold mb-2 text-sm">Step 1 — Select CSV File</h3>
      <input type="file" id="bulk-csv" class="mb-3" />
      <button id="download-sample" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">
        Download Sample CSV
      </button>
    </div>
    <div id="preview-panel" class="hidden bg-white p-4 rounded shadow mb-4">
      <h3 class="font-semibold mb-2 text-sm">Step 2 — Preview Parsed Data</h3>
      <table class="w-full text-xs border" id="preview-table"></table>
    </div>
    <div id="validate-panel" class="hidden bg-white p-4 rounded shadow mb-4">
      <button id="validate-csv" class="bg-yellow-600 text-white px-4 py-2 rounded text-sm">
        Validate CSV
      </button>
      <p id="validation-status" class="text-xs mt-2 text-slate-600"></p>
    </div>
    <div id="process-panel" class="hidden bg-white p-4 rounded shadow mb-4">
      <button id="bulk-process" class="bg-emerald-700 text-white px-4 py-2 rounded text-sm">
        Process & Assign Roles
      </button>
    </div>
    <pre id="bulk-output" class="bg-black text-green-400 p-3 mt-3 text-xs h-64 overflow-auto"></pre>
  </section>

  <!-- REPORTS -->
  <section id="panel-reports" class="hidden">
    <h2 class="text-2xl font-semibold mb-4">Reports</h2>
  </section>

  <!-- LOGS -->
  <section id="panel-logs" class="hidden">
    <h2 class="text-2xl font-semibold mb-4">System Logs</h2>
    <ul id="logs-list" class="text-xs bg-white p-3 shadow rounded h-64 overflow-auto"></ul>
  </section>
</main>

<!-- FIREBASE SCRIPT -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    GoogleAuthProvider,
    signInWithPopup,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    collection,
    query,
    where,
    getDocs,
    setDoc,
    collectionGroup
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // --- FIREBASE CONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyC1Aa_mnq_0g7ZEuLbYVjN62iCMWemlKUc",
    authDomain: "kmit-marks-portal-9db76.firebaseapp.com",
    projectId: "kmit-marks-portal-9db76",
    storageBucket: "kmit-marks-portal-9db76.appspot.com",
    messagingSenderId: "264909025742",
    appId: "1:264909025742:web:84de5216860219e6bc3b9f"
  };

  const appId = "kmit-marks-portal";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let currentAdmin = null;

  function showError(msg) {
    const box = document.getElementById("errorBox");
    box.textContent = msg;
    box.classList.remove("hidden");
    setTimeout(() => box.classList.add("hidden"), 8000);
  }

  function showApp(user) {
    const sidebar = document.getElementById("sidebar");
    const mainApp = document.getElementById("mainApp");
    sidebar.classList.remove("hidden");
    sidebar.classList.remove("-translate-x-full"); // show by default on desktop
    mainApp.classList.remove("hidden");
    document.getElementById("admin-email").textContent = user.email;

    // Load last panel state after auth
    if (window.loadAdminUI) window.loadAdminUI();
  }

  async function checkRole(user) {
    const roleRef = doc(
      db,
      "artifacts",
      appId,
      "users",
      user.uid,
      "user_config",
      "role"
    );
    const snap = await getDoc(roleRef);
    if (!snap.exists()) {
      showError("Role missing. Create Firestore doc with role=ADMIN");
      return false;
    }
    if ((snap.data().role || "").toUpperCase() !== "ADMIN") {
      showError("Access denied. ADMIN only.");
      return false;
    }
    return true;
  }

  // Login handler
  async function googleLogin() {
    try {
      await signInWithPopup(auth, provider);
    } catch (err) {
      if (err.code === "auth/unauthorized-domain") {
        showError(
          "ERROR: Unauthorized Domain. Add domain in Firebase Authentication → Authorized Domains."
        );
      } else if (err.code === "auth/popup-blocked") {
        showError("Popup blocked. Enable popups and retry.");
      } else {
        showError("Login Failed: " + err.message);
      }
    }
  }

  // Sign out
  const signOutBtn = document.getElementById("sign-out-btn");
  if (signOutBtn) {
    signOutBtn.onclick = () => signOut(auth).then(() => location.reload());
  }

  // Auth state watcher
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      googleLogin();
      return;
    }
    const ok = await checkRole(user);
    if (ok) {
      currentAdmin = user;
      showApp(user);
    }
  });

  /* --------------------------------------
     SIDEBAR TOGGLE (FLOATING BUTTON)
  -------------------------------------- */
  const sidebar = document.getElementById("sidebar");
  const sidebarToggle = document.getElementById("sidebar-toggle");
  const sidebarOverlay = document.getElementById("sidebar-overlay");

  function closeSidebarMobile() {
    sidebar.classList.add("-translate-x-full");
    sidebarOverlay.classList.add("hidden");
  }

  function openSidebarMobile() {
    sidebar.classList.remove("-translate-x-full");
    sidebarOverlay.classList.remove("hidden");
  }

  if (sidebarToggle) {
    sidebarToggle.addEventListener("click", () => {
      if (sidebar.classList.contains("-translate-x-full")) {
        openSidebarMobile();
      } else {
        closeSidebarMobile();
      }
    });
  }

  if (sidebarOverlay) {
    sidebarOverlay.addEventListener("click", closeSidebarMobile);
  }

  /* --------------------------------------
     SIDEBAR NAVIGATION + LAST PANEL
  -------------------------------------- */
  const navButtons = document.querySelectorAll("#nav-links button");
  const panels = {
    overview: document.getElementById("panel-overview"),
    marks: document.getElementById("panel-marks"),
    roles: document.getElementById("panel-roles"),
    rolemanager: document.getElementById("panel-rolemanager"),
    users: document.getElementById("panel-users"),
    bulkroles: document.getElementById("panel-bulkroles"),
    reports: document.getElementById("panel-reports"),
    logs: document.getElementById("panel-logs")
  };

  function hideAllPanels() {
    Object.values(panels).forEach((p) => {
      p.classList.add("hidden");
      p.style.opacity = 0;
    });
  }

  function showPanel(panel) {
    panel.classList.remove("hidden");
    panel.style.opacity = 0;
    setTimeout(() => {
      panel.style.opacity = 1;
    }, 10);
  }

  function setActiveButton(btn) {
    navButtons.forEach((b) => b.classList.remove("bg-slate-800"));
    btn.classList.add("bg-slate-800");
  }

  function saveLastPanel(panelName) {
    localStorage.setItem("last_panel", panelName);
  }

  function loadLastPanel() {
    const last = localStorage.getItem("last_panel") || "overview";
    const btn = document.querySelector(`[data-target="${last}"]`);
    if (btn) btn.click();
  }

  navButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.target;
      setActiveButton(btn);
      hideAllPanels();
      showPanel(panels[target]);
      saveLastPanel(target);
      // close sidebar on mobile
      if (window.innerWidth < 768) closeSidebarMobile();

      // lazy load users when opening Users Directory
      if (target === "users") {
        loadAllUsers();
      }
    });
  });

  window.loadAdminUI = function () {
    setTimeout(loadLastPanel, 200);
  };

  /* --------------------------------------
     SUBJECT LOADING (FIRESTORE)
  -------------------------------------- */
  const regSel = document.getElementById("marks-reg");
  const branchSel = document.getElementById("marks-branch");
  const yearSel = document.getElementById("marks-year");
  const semSel = document.getElementById("marks-sem");
  const paperTypeSel = document.getElementById("marks-paper-type");
  const subjectSel = document.getElementById("marks-subject");
  const examTypeSel = document.getElementById("marks-exam");
  const batchSel = document.getElementById("marks-batch");

  async function loadSubjectsForFilters() {
    const reg = regSel.value;
    const branch = branchSel.value;
    const year = yearSel.value;
    const sem = semSel.value;
    const type = paperTypeSel.value;

    if (!reg || !branch || !year || !sem || !type) {
      subjectSel.innerHTML =
        '<option value="">Select subject (fill filters above)</option>';
      return;
    }

    try {
      const qRef = query(
        collection(db, "subjects"),
        where("reg", "==", reg),
        where("branch", "==", branch),
        where("year", "==", year),
        where("sem", "==", sem),
        where("type", "==", type)
      );
      const snap = await getDocs(qRef);

      if (snap.empty) {
        subjectSel.innerHTML =
          '<option value="">No subjects configured for this combination</option>';
        return;
      }

      subjectSel.innerHTML = "";
      snap.forEach((docSnap) => {
        const data = docSnap.data();
        const opt = document.createElement("option");
        opt.value = JSON.stringify({
          id: docSnap.id,
          name: data.subjectName,
          code: data.subjectCode
        });
        opt.textContent = `${data.subjectName} (${data.subjectCode})`;
        subjectSel.appendChild(opt);
      });
    } catch (err) {
      showError("Failed to load subjects: " + err.message);
    }
  }

  [regSel, branchSel, yearSel, semSel, paperTypeSel].forEach((el) =>
    el.addEventListener("change", loadSubjectsForFilters)
  );

  /* --------------------------------------
     SUBJECT CSV UPLOAD + SAMPLE
  -------------------------------------- */
  const subjectCsvInput = document.getElementById("subject-csv");
  const subjectUploadBtn = document.getElementById("subject-upload-btn");
  const subjectSampleBtn = document.getElementById("subject-sample-btn");
  const subjectStatus = document.getElementById("subject-upload-status");

  if (subjectSampleBtn) {
    subjectSampleBtn.addEventListener("click", () => {
      const csv =
        "regulation,branch,year,sem,subjectName,subjectCode,type\n" +
        "KR24,CSE,II,I,Artificial Intelligence,243AG,THEORY\n";
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "subjects_sample.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  }

  if (subjectUploadBtn) {
    subjectUploadBtn.addEventListener("click", async () => {
      const file = subjectCsvInput.files[0];
      if (!file) {
        subjectStatus.textContent = "Please select a CSV file.";
        return;
      }
      try {
        subjectStatus.textContent = "Reading CSV...";
        const text = await file.text();
        const rows = text
          .split(/\r?\n/)
          .map((r) => r.trim())
          .filter((r) => r.length);

        if (rows.length <= 1) {
          subjectStatus.textContent = "CSV has no data rows.";
          return;
        }

        const header = rows[0]
          .split(",")
          .map((h) => h.trim().toLowerCase());
        const colIndex = (name) => header.indexOf(name);

        const idx = {
          regulation: colIndex("regulation"),
          branch: colIndex("branch"),
          year: colIndex("year"),
          sem: colIndex("sem"),
          subjectName: colIndex("subjectname"),
          subjectCode: colIndex("subjectcode"),
          type: colIndex("type")
        };

        if (
          Object.values(idx).some((v) => v === -1)
        ) {
          subjectStatus.textContent =
            "Header row must contain: regulation, branch, year, sem, subjectName, subjectCode, type";
          return;
        }

        let successCount = 0;
        for (let i = 1; i < rows.length; i++) {
          const cols = rows[i].split(",").map((c) => c.trim());
          if (!cols.length || cols[0].startsWith("#")) continue;

          const data = {
            reg: cols[idx.regulation],
            branch: cols[idx.branch],
            year: cols[idx.year],
            sem: cols[idx.sem],
            subjectName: cols[idx.subjectName],
            subjectCode: cols[idx.subjectCode],
            type: cols[idx.type]
          };

          if (!data.subjectName || !data.subjectCode) continue;

          const id =
            data.reg +
            "_" +
            data.branch +
            "_" +
            data.year +
            "_" +
            data.sem +
            "_" +
            data.subjectCode;
          await setDoc(doc(db, "subjects", id), data, { merge: true });
          successCount++;
        }
        subjectStatus.textContent = `Uploaded/updated ${successCount} subject(s).`;
        loadSubjectsForFilters();
      } catch (err) {
        subjectStatus.textContent = "Error uploading subjects: " + err.message;
      }
    });
  }

  /* --------------------------------------
     COLUMN EDITOR + TEMPLATE GENERATOR
  -------------------------------------- */
  const dynamicColumnsContainer = document.getElementById("dynamic-columns");
  const addColumnBtn = document.getElementById("add-column-btn");
  const newColumnInput = document.getElementById("new-column-name");
  const templatePreview = document.getElementById("template-preview");
  const generateTemplateBtn = document.getElementById("generate-template");

  let dynamicColumns = [];

  const theoryDefaultColumns = [
    "1a",
    "1b",
    "2a",
    "2b",
    "3a",
    "3b",
    "4a",
    "4b",
    "5a",
    "5b",
    "Part-C (5 Marks)",
    "Part-A Objective (10 Marks)",
    "Descriptive 15 Marks",
    "Total (40)",
    "Remarks"
  ];

  const labDefaultColumns = [
    "Experiment No",
    "Observation / Procedure",
    "Record",
    "Viva",
    "Internal (40)",
    "Remarks"
  ];

  function resetColumnsForPaperType() {
    if (paperTypeSel.value === "LAB") {
      dynamicColumns = [...labDefaultColumns];
    } else {
      dynamicColumns = [...theoryDefaultColumns];
    }
    renderDynamicColumns();
  }

  function renderDynamicColumns() {
    dynamicColumnsContainer.innerHTML = "";
    dynamicColumns.forEach((col, index) => {
      const chip = document.createElement("button");
      chip.type = "button";
      chip.className =
        "px-2 py-1 bg-indigo-50 border border-indigo-300 rounded-full text-[11px] hover:bg-red-50 hover:border-red-300";
      chip.textContent = col;
      chip.title = "Click to remove";
      chip.addEventListener("click", () => {
        dynamicColumns.splice(index, 1);
        renderDynamicColumns();
      });
      dynamicColumnsContainer.appendChild(chip);
    });
  }

  addColumnBtn.addEventListener("click", () => {
    const name = newColumnInput.value.trim();
    if (!name) return;
    dynamicColumns.push(name);
    newColumnInput.value = "";
    renderDynamicColumns();
  });

  paperTypeSel.addEventListener("change", resetColumnsForPaperType);
  resetColumnsForPaperType(); // initial

  generateTemplateBtn.addEventListener("click", () => {
    const batch = batchSel.value || "-";
    const reg = regSel.value;
    const branch = branchSel.value;
    const year = yearSel.value;
    const sem = semSel.value;
    const examText =
      examTypeSel.options[examTypeSel.selectedIndex]?.text || "";
    const paperType = paperTypeSel.value;

    if (!subjectSel.value) {
      showError("Please select a subject before generating the template.");
      return;
    }

    let subjectData;
    try {
      subjectData = JSON.parse(subjectSel.value);
    } catch {
      showError("Invalid subject selection.");
      return;
    }

    const fixedColumns = ["S.No", "Hall Ticket No", "Name of the Student"];
    const columns = [...fixedColumns, ...dynamicColumns];

    let html = "";
    html += `<div class="mb-3 text-[11px] space-y-1">
      <div><span class="font-semibold">Batch:</span> ${batch}</div>
      <div><span class="font-semibold">Regulation:</span> ${reg}</div>
      <div><span class="font-semibold">Branch:</span> ${branch}</div>
      <div><span class="font-semibold">Year / Sem:</span> ${year} - ${sem}</div>
      <div><span class="font-semibold">Subject:</span> ${subjectData.name} (${subjectData.code})</div>
      <div><span class="font-semibold">Exam / Type:</span> ${examText} (${paperType})</div>
    </div>`;

    html += `<table class="min-w-full text-[11px] border border-slate-300 border-collapse">
      <thead><tr>`;
    columns.forEach((c) => {
      html += `<th class="border border-slate-300 px-2 py-1 bg-slate-100">${c}</th>`;
    });
    html += `</tr></thead><tbody>`;

    for (let i = 1; i <= 10; i++) {
      html += "<tr>";
      columns.forEach((col, idx) => {
        let value = "";
        if (idx === 0) value = i;
        html += `<td class="border border-slate-200 px-2 py-1 h-6">${value}</td>`;
      });
      html += "</tr>";
    }

    html += "</tbody></table>";

    templatePreview.innerHTML = html;
    templatePreview.classList.remove("hidden");
  });

  /* --------------------------------------
     BASIC ROLE FORM (panel-roles)
  -------------------------------------- */
  const roleForm = document.getElementById("role-form");
  const roleStatus = document.getElementById("role-status");

  if (roleForm) {
    roleForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      roleStatus.textContent = "";
      const fd = new FormData(roleForm);
      const uid = fd.get("uid").trim();
      const role = fd.get("role");

      if (!uid) {
        roleStatus.textContent = "Please enter a UID.";
        return;
      }

      try {
        roleStatus.textContent = "Saving role…";
        await setDoc(
          doc(db, "artifacts", appId, "users", uid, "user_config", "role"),
          { role },
          { merge: true }
        );
        roleStatus.textContent = `Role saved: ${role} for UID ${uid}.`;
      } catch (err) {
        roleStatus.textContent = "Error saving role: " + err.message;
      }
    });
  }

  /* --------------------------------------
     ROLE MANAGER PANEL (panel-rolemanager)
  -------------------------------------- */
  const rmUidInput = document.getElementById("rm-uid");
  const rmEmailInput = document.getElementById("rm-email");
  const rmRoleSelect = document.getElementById("rm-role");
  const rmLoadBtn = document.getElementById("rm-load");
  const rmSaveBtn = document.getElementById("rm-save");
  const rmStatus = document.getElementById("rm-status");
  const rmCurrentRole = document.getElementById("rm-current-role");
  const rmEmailSearchBtn = document.getElementById("rm-email-search");

  async function loadRoleForUid() {
    rmStatus.textContent = "";
    rmCurrentRole.textContent = "";

    const uid = (rmUidInput?.value || "").trim();
    if (!uid) {
      rmStatus.textContent = "Enter a UID first.";
      return;
    }
    try {
      rmStatus.textContent = "Loading role…";
      const roleRef = doc(
        db,
        "artifacts",
        appId,
        "users",
        uid,
        "user_config",
        "role"
      );
      const snap = await getDoc(roleRef);
      if (!snap.exists()) {
        rmCurrentRole.textContent = "No role set for this UID.";
        rmRoleSelect.value = "FACULTY";
        rmStatus.textContent = "";
        rmEmailInput.value = "";
        return;
      }
      const data = snap.data() || {};
      const role = (data.role || "").toUpperCase();
      rmCurrentRole.textContent = `Current role: ${role}`;
      if (["ADMIN", "FACULTY", "HOD", "EXAMCELL", "NONE"].includes(role)) {
        rmRoleSelect.value = role;
      }
      if (data.email) {
        rmEmailInput.value = data.email;
      }
      rmStatus.textContent = "";
    } catch (err) {
      rmStatus.textContent = "Error loading role: " + err.message;
    }
  }

  if (rmLoadBtn) {
    rmLoadBtn.addEventListener("click", loadRoleForUid);
  }

  if (rmEmailSearchBtn) {
    rmEmailSearchBtn.addEventListener("click", async () => {
      const email = (rmEmailInput?.value || "").trim().toLowerCase();
      rmStatus.textContent = "";
      rmCurrentRole.textContent = "";

      if (!email) {
        rmStatus.textContent = "Enter an email to search.";
        return;
      }

      try {
        rmStatus.textContent = "Searching by email…";
        const cg = collectionGroup(db, "user_config");
        const snap = await getDocs(cg);
        let foundDoc = null;
        snap.forEach((d) => {
          if (foundDoc) return;
          const data = d.data() || {};
          if ((data.email || "").toLowerCase() === email) {
            foundDoc = d;
          }
        });

        if (!foundDoc) {
          rmStatus.textContent = "No user found with that email in role docs.";
          return;
        }

        const pathSeg = foundDoc.ref.path.split("/");
        const uid = pathSeg[3] || "";
        rmUidInput.value = uid;
        rmStatus.textContent = `Found UID: ${uid}`;
        await loadRoleForUid();
      } catch (err) {
        rmStatus.textContent = "Error searching by email: " + err.message;
      }
    });
  }

  if (rmSaveBtn) {
    rmSaveBtn.addEventListener("click", async () => {
      rmStatus.textContent = "";
      const uid = (rmUidInput?.value || "").trim();
      const role = rmRoleSelect?.value;
      const email = (rmEmailInput?.value || "").trim();

      if (!uid) {
        rmStatus.textContent = "Enter a UID first.";
        return;
      }
      if (!role) {
        rmStatus.textContent = "Select a role.";
        return;
      }

      try {
        rmStatus.textContent = "Saving role…";
        const newRoleValue = role === "NONE" ? null : role;
        const payload = { role: newRoleValue };
        if (email) payload.email = email;

        await setDoc(
          doc(db, "artifacts", appId, "users", uid, "user_config", "role"),
          payload,
          { merge: true }
        );
        rmStatus.textContent = `Role updated to ${role} for UID ${uid}.`;
        await loadRoleForUid();
      } catch (err) {
        rmStatus.textContent = "Error saving role: " + err.message;
      }
    });
  }

  /* --------------------------------------
     USERS DIRECTORY PANEL
  -------------------------------------- */
  const usersReloadBtn = document.getElementById("users-reload");
  const usersStatus = document.getElementById("users-status");
  const usersTableBody = document.getElementById("users-table-body");

  async function loadAllUsers() {
    if (!usersTableBody) return;
    usersStatus.textContent = "Loading users…";
    usersTableBody.innerHTML = "";

    try {
      const cg = collectionGroup(db, "user_config");
      const snap = await getDocs(cg);
      let count = 0;

      snap.forEach((docSnap) => {
        const data = docSnap.data() || {};
        const pathSeg = docSnap.ref.path.split("/");
        const uid = pathSeg[3] || "";
        const role = (data.role || "").toUpperCase();
        const email = data.email || "";

        const tr = document.createElement("tr");

        const tdEmail = document.createElement("td");
        tdEmail.className = "border border-slate-200 px-2 py-1";
        tdEmail.textContent = email || "-";

        const tdUid = document.createElement("td");
        tdUid.className = "border border-slate-200 px-2 py-1 font-mono text-[10px]";
        tdUid.textContent = uid;

        const tdRole = document.createElement("td");
        tdRole.className = "border border-slate-200 px-2 py-1";
        tdRole.textContent = role || "-";

        const tdActions = document.createElement("td");
        tdActions.className = "border border-slate-200 px-2 py-1 space-x-1";

        const copyBtn = document.createElement("button");
        copyBtn.type = "button";
        copyBtn.className =
          "px-2 py-0.5 rounded border border-slate-300 text-[10px] hover:bg-slate-100";
        copyBtn.textContent = "Copy UID";
        copyBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(uid);
            usersStatus.textContent = `Copied UID: ${uid}`;
          } catch {
            usersStatus.textContent = "Failed to copy UID.";
          }
        });

        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className =
          "px-2 py-0.5 rounded border border-indigo-400 text-[10px] hover:bg-indigo-50";
        editBtn.textContent = "Edit Role";
        editBtn.addEventListener("click", async () => {
          const rmBtn = document.querySelector('[data-target="rolemanager"]');
          if (rmBtn) rmBtn.click();
          if (rmUidInput) rmUidInput.value = uid;
          if (rmEmailInput) rmEmailInput.value = email || "";
          await loadRoleForUid();
        });

        tdActions.appendChild(copyBtn);
        tdActions.appendChild(editBtn);

        tr.appendChild(tdEmail);
        tr.appendChild(tdUid);
        tr.appendChild(tdRole);
        tr.appendChild(tdActions);

        usersTableBody.appendChild(tr);
        count++;
      });

      if (!count) {
        usersStatus.textContent = "No users found in role docs.";
      } else {
        usersStatus.textContent = `Loaded ${count} user(s).`;
      }
    } catch (err) {
      usersStatus.textContent = "Error loading users: " + err.message;
    }
  }

  if (usersReloadBtn) {
    usersReloadBtn.addEventListener("click", loadAllUsers);
  }
</script>
</body>
</html>
